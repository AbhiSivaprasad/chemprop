"""Converts a GO hierarchy into a DAG."""
from typing import Set

from goatools.obo_parser import GODag

from dag import RootedDAG, Node
from dag_model import DAGModel
from chemprop.nn_utils import param_count


def go_to_dag(go_dag: GODag, go_ids: Set[str]) -> RootedDAG:
    """Given a GODag and a list of go_ids, builds a DAG object containing the provided go_ids."""
    go_id_to_node = {go_id: Node(go_id) for go_id in go_ids}

    for go_id, go_node in go_id_to_node.items():
        go_node.parents = {go_id_to_node[parent_go_id.item_id] for parent_go_id in go_dag[go_id].parents
                           if parent_go_id.item_id in go_ids}
        go_node.children = {go_id_to_node[child_go_id.item_id] for child_go_id in go_dag[go_id].children
                            if child_go_id.item_id in go_ids}

    dag = RootedDAG(set(go_id_to_node.values()))

    return dag


if __name__ == '__main__':
    go_dag = GODag('../../../antibiotic_moa/go-basic.obo')
    go_ids = [
        'GO:0000122',
        'GO:0000270',
        'GO:0000271',
        'GO:0000910',
        'GO:0000917',
        'GO:0001505',
        'GO:0001539',
        'GO:0001558',
        'GO:0001932',
        'GO:0001933',
        'GO:0005975',
        'GO:0005976',
        'GO:0006022',
        'GO:0006023',
        'GO:0006024',
        'GO:0006082',
        'GO:0006090',
        'GO:0006091',
        'GO:0006096',
        'GO:0006139',
        'GO:0006163',
        'GO:0006165',
        'GO:0006259',
        'GO:0006260',
        'GO:0006261',
        'GO:0006281',
        'GO:0006355',
        'GO:0006357',
        'GO:0006464',
        'GO:0006468',
        'GO:0006470',
        'GO:0006508',
        'GO:0006515',
        'GO:0006518',
        'GO:0006520',
        'GO:0006629',
        'GO:0006631',
        'GO:0006633',
        'GO:0006644',
        'GO:0006725',
        'GO:0006753',
        'GO:0006757',
        'GO:0006790',
        'GO:0006793',
        'GO:0006796',
        'GO:0006807',
        'GO:0006810',
        'GO:0006928',
        'GO:0006950',
        'GO:0006974',
        'GO:0006996',
        'GO:0007049',
        'GO:0007154',
        'GO:0007267',
        'GO:0008104',
        'GO:0008150',
        'GO:0008152',
        'GO:0008219',
        'GO:0008360',
        'GO:0008610',
        'GO:0008653',
        'GO:0008654',
        'GO:0009056',
        'GO:0009058',
        'GO:0009059',
        'GO:0009103',
        'GO:0009117',
        'GO:0009132',
        'GO:0009135',
        'GO:0009150',
        'GO:0009165',
        'GO:0009179',
        'GO:0009185',
        'GO:0009225',
        'GO:0009226',
        'GO:0009237',
        'GO:0009252',
        'GO:0009259',
        'GO:0009308',
        'GO:0009311',
        'GO:0009312',
        'GO:0009372',
        'GO:0009405',
        'GO:0009595',
        'GO:0009605',
        'GO:0009607',
        'GO:0009628',
        'GO:0009889',
        'GO:0009890',
        'GO:0009891',
        'GO:0009892',
        'GO:0009893',
        'GO:0009894',
        'GO:0009966',
        'GO:0009968',
        'GO:0009987',
        'GO:0010468',
        'GO:0010556',
        'GO:0010557',
        'GO:0010558',
        'GO:0010563',
        'GO:0010604',
        'GO:0010605',
        'GO:0010628',
        'GO:0010629',
        'GO:0010646',
        'GO:0010648',
        'GO:0010941',
        'GO:0010942',
        'GO:0012501',
        'GO:0015031',
        'GO:0015833',
        'GO:0016043',
        'GO:0016051',
        'GO:0016052',
        'GO:0016053',
        'GO:0016070',
        'GO:0016310',
        'GO:0016311',
        'GO:0016999',
        'GO:0017000',
        'GO:0017001',
        'GO:0017144',
        'GO:0018130',
        'GO:0019184',
        'GO:0019219',
        'GO:0019220',
        'GO:0019222',
        'GO:0019290',
        'GO:0019438',
        'GO:0019538',
        'GO:0019637',
        'GO:0019693',
        'GO:0019748',
        'GO:0019752',
        'GO:0022402',
        'GO:0022414',
        'GO:0022603',
        'GO:0022604',
        'GO:0022607',
        'GO:0023051',
        'GO:0023052',
        'GO:0023057',
        'GO:0030162',
        'GO:0030203',
        'GO:0030653',
        'GO:0030655',
        'GO:0030682',
        'GO:0030856',
        'GO:0031323',
        'GO:0031324',
        'GO:0031325',
        'GO:0031326',
        'GO:0031327',
        'GO:0031328',
        'GO:0031329',
        'GO:0031347',
        'GO:0031348',
        'GO:0031399',
        'GO:0031400',
        'GO:0032268',
        'GO:0032269',
        'GO:0032502',
        'GO:0032506',
        'GO:0032787',
        'GO:0032879',
        'GO:0033036',
        'GO:0033554',
        'GO:0033692',
        'GO:0034622',
        'GO:0034637',
        'GO:0034641',
        'GO:0034645',
        'GO:0034654',
        'GO:0034660',
        'GO:0035821',
        'GO:0035897',
        'GO:0036211',
        'GO:0040007',
        'GO:0040008',
        'GO:0040011',
        'GO:0042176',
        'GO:0042221',
        'GO:0042325',
        'GO:0042326',
        'GO:0042710',
        'GO:0042886',
        'GO:0042908',
        'GO:0042981',
        'GO:0043043',
        'GO:0043065',
        'GO:0043067',
        'GO:0043068',
        'GO:0043093',
        'GO:0043170',
        'GO:0043207',
        'GO:0043408',
        'GO:0043409',
        'GO:0043412',
        'GO:0043436',
        'GO:0043603',
        'GO:0043604',
        'GO:0043605',
        'GO:0043933',
        'GO:0044003',
        'GO:0044010',
        'GO:0044033',
        'GO:0044036',
        'GO:0044038',
        'GO:0044106',
        'GO:0044110',
        'GO:0044117',
        'GO:0044119',
        'GO:0044237',
        'GO:0044238',
        'GO:0044248',
        'GO:0044249',
        'GO:0044255',
        'GO:0044260',
        'GO:0044262',
        'GO:0044264',
        'GO:0044267',
        'GO:0044270',
        'GO:0044271',
        'GO:0044281',
        'GO:0044283',
        'GO:0044403',
        'GO:0044414',
        'GO:0044419',
        'GO:0044531',
        'GO:0044532',
        'GO:0044533',
        'GO:0044550',
        'GO:0044764',
        'GO:0045184',
        'GO:0045226',
        'GO:0045229',
        'GO:0045595',
        'GO:0045601',
        'GO:0045892',
        'GO:0045893',
        'GO:0045934',
        'GO:0045935',
        'GO:0045936',
        'GO:0046031',
        'GO:0046034',
        'GO:0046379',
        'GO:0046394',
        'GO:0046483',
        'GO:0046677',
        'GO:0046700',
        'GO:0046928',
        'GO:0046929',
        'GO:0046939',
        'GO:0048518',
        'GO:0048519',
        'GO:0048522',
        'GO:0048523',
        'GO:0048583',
        'GO:0048585',
        'GO:0048870',
        'GO:0050789',
        'GO:0050793',
        'GO:0050794',
        'GO:0050804',
        'GO:0050805',
        'GO:0050896',
        'GO:0051046',
        'GO:0051048',
        'GO:0051049',
        'GO:0051051',
        'GO:0051128',
        'GO:0051171',
        'GO:0051172',
        'GO:0051173',
        'GO:0051174',
        'GO:0051179',
        'GO:0051234',
        'GO:0051239',
        'GO:0051246',
        'GO:0051248',
        'GO:0051252',
        'GO:0051253',
        'GO:0051254',
        'GO:0051258',
        'GO:0051276',
        'GO:0051301',
        'GO:0051588',
        'GO:0051589',
        'GO:0051603',
        'GO:0051606',
        'GO:0051701',
        'GO:0051703',
        'GO:0051704',
        'GO:0051707',
        'GO:0051716',
        'GO:0051817',
        'GO:0052031',
        'GO:0052167',
        'GO:0052170',
        'GO:0052173',
        'GO:0052200',
        'GO:0052553',
        'GO:0052562',
        'GO:0052572',
        'GO:0055085',
        'GO:0055086',
        'GO:0055114',
        'GO:0060245',
        'GO:0060255',
        'GO:0060284',
        'GO:0060341',
        'GO:0061136',
        'GO:0065003',
        'GO:0065007',
        'GO:0065008',
        'GO:0070265',
        'GO:0070589',
        'GO:0071103',
        'GO:0071554',
        'GO:0071555',
        'GO:0071702',
        'GO:0071704',
        'GO:0071705',
        'GO:0071770',
        'GO:0071806',
        'GO:0071840',
        'GO:0071897',
        'GO:0071973',
        'GO:0071978',
        'GO:0072330',
        'GO:0072338',
        'GO:0072340',
        'GO:0072521',
        'GO:0075136',
        'GO:0080090',
        'GO:0080134',
        'GO:0090304',
        'GO:0090305',
        'GO:0090407',
        'GO:0090529',
        'GO:0097300',
        'GO:0097588',
        'GO:0098630',
        'GO:0098743',
        'GO:0099177',
        'GO:1901135',
        'GO:1901137',
        'GO:1901293',
        'GO:1901360',
        'GO:1901361',
        'GO:1901362',
        'GO:1901550',
        'GO:1901564',
        'GO:1901565',
        'GO:1901566',
        'GO:1901575',
        'GO:1901576',
        'GO:1902531',
        'GO:1902532',
        'GO:1902679',
        'GO:1902680',
        'GO:1903050',
        'GO:1903140',
        'GO:1903362',
        'GO:1903506',
        'GO:1903507',
        'GO:1903508',
        'GO:1903509',
        'GO:1903530',
        'GO:1903531',
        'GO:2000026',
        'GO:2000112',
        'GO:2000113',
        'GO:2001141'
    ]
    dag = go_to_dag(go_dag, set(go_ids))
    go_dag_model = DAGModel(dag, 300, 100)
    import torch
    embedding = torch.randn(50, 300)
    print(go_dag_model)
    print(param_count(go_dag_model))
    exit()
    print(go_dag_model(embedding))
